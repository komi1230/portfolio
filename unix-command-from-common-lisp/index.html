<!DOCTYPE html>
<html lang="en">

  <head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177061519-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-177061519-1');
    </script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Yusuke Kominami's Blog">
    <meta name="author" content="Yusuke Kominami">
    <meta property="og:title" content="Launch Today" />
    <meta property="og:description" content="Yusuke Kominami's Blog" />
    <meta property="og:image" content="https://komi.dev/img/home-bg.jpg" />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:site_name" content="Launch Today" />
    <meta property="og:url" content="https://komi.dev" />
    <meta name="twitter:site" content="@komi_edtr_1230" />
    <meta name="twitter:card" content="summary_large_image">

    <title>Launch Today</title>

    <link rel="icon" href="https://komi.dev/img/favicon.ico" />

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;bootstrap.min.css">
    <!-- Custom fonts for this template -->
    <link href=" https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;all.min.css" rel=" stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
          type='text/css'>
    <link
      href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
      rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;clean-blog.css">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" href="/">Launch Today</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
                aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev">Home</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev&#x2F;about">About</a>
            </li>
            
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    
<!-- Page Header -->
<header class="masthead" style="background-image: url('https:&#x2F;&#x2F;komi.dev&#x2F;img&#x2F;post-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          
<h1>	Common LispのソースコードからUnixコマンドを叩く</h1>
<span class="meta">Posted on 23 December 2019</span>

        </div>
      </div>
    </div>
  </div>
</header>


    
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <p>やや久しぶりの更新。</p>
<p>最近はあまりLispを書いてなくて、ずっとベイズ深層学習の勉強をしている。</p>
<p>先日なんとなく書店をフラフラしていたところコンピュータサイエンス系の棚にて須山さんの『ベイズ深層学習』を発見し、勢いで購入したのだけれどこれがなかなか面白い。</p>
<p>いわゆる頻度論的なアプローチとベイズ的なアプローチをうまく対比させていて、どう異なっていてどう共通部分を見出せるかについてかなり簡潔に説明されており、ベイズについては1年前にPRMLを読んだだけだったので久しぶりにしっかり手を動かして読み進めている。</p>
<p>そういえばCommon Lispでベイズ系のライブラリは無かった気がするので実装しようかなという構想がある。</p>
<p>ベイズ推論は尤度関数などをしっかり計算しようとするとなかなか計算量がハードで、ベイズ推論パッケージであるStanは記述されたモデルを一度C++にトランスレートして計算しているので、C並みの速度が出るCommon Lispならマクロなどを活用することでCommon Lispネイティブで実装ができると踏んでいる。</p>
<p>Common Lispでやりたいことはたくさんあるのだけれど、時間が空き次第しっかり開発に着手しようと思う。</p>
<p>さて、本題へ。</p>
<h3 id="sosukodokaraunixkomando">ソースコードからUnixコマンド</h3>
<p>PythonなどでUnixコマンドを叩こうとする際は <code>subprocess</code> を使うことでなんとかできる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">subprocess </span><span style="color:#b48ead;">as </span><span style="color:#c0c5ce;">sp

sp.</span><span style="color:#bf616a;">call</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">pwd</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#65737e;"># =&gt; &quot;/path/to/your/current/directory&quot;
</span></code></pre>
<p>引数ありのUnixコマンドを叩く際は、引数にリストとして入れてあげればできる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">subprocess </span><span style="color:#b48ead;">as </span><span style="color:#c0c5ce;">sp

sp.</span><span style="color:#bf616a;">call</span><span style="color:#c0c5ce;">([&quot;</span><span style="color:#a3be8c;">ls</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">Desktop</span><span style="color:#c0c5ce;">&quot;])
</span></code></pre>
<p>このようにソースコードからUnixコマンドを叩くことができると色々なツールのラッパーを簡単に作成することができる。(例えばGnuplotとか)</p>
<p>さて、こうしたUnixコマンドをソースコードから叩くのをCommon Lispでやるのはややめんどくさい。</p>
<p>というのも処理系依存だからである。</p>
<p>例えば自分が普段から使っているSBCLは <code>sb-ext:run-program</code> で、</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(sb-ext:run-program &quot;/bin/ls&quot; &#39;(&quot;Desktop&quot;) :output t) 
</span></code></pre>
<p>という具合になる。</p>
<p>しかしこれはSBCLの場合で、CLISPやCCLとなるとまた変わってくる。</p>
<p>ちなみにSBCLではこの <code>sb-ext:run-program</code> によって解決できるが、SLIMEでこれを使おうとするとまた別の問題が起こり、標準出力ができずに失敗するのでstreamとして渡してあげる必要がある。</p>
<p>まあ要するに汎用的なコードを書くには問題だらけなのである。</p>
<h3 id="trivial-shelltoiuxuan-ze">trivial-shellという選択</h3>
<p>さて、Common Lispには <code>trivial-shell</code> というライブラリがある。</p>
<p>これは上記の問題を解決するために用意されたもので、簡単に使える。</p>
<p>例えば</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(ql:quickload :trivial-shell)

(</span><span style="color:#b48ead;">defun </span><span style="color:#8fa1b3;">system </span><span style="color:#c0c5ce;">(cmd-str)
 (trivial-shell:shell-command cmd-str))
</span></code></pre>
<p>とすれば <code>(system &quot;ls&quot;)</code> のようにして使え、Pythonの <code>subprocess</code> とほぼ同様のインターフェースが実現できる。</p>
<p>この <code>trivial-shell</code> は上記のSLIMEでの問題も解決している。</p>
<p>だいたいはこれで問題なさそう。</p>
<p>ただ一つ文句をつけるとすれば、<code>ls</code> での結果表示が <code>#\Newline</code> によって改行されており、結果をリストとして表示するにはちょっと一手間を加える必要がある。</p>
<p>自分は上記の画像の通り、以下のようなやり方で解決している。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(ql:quickload :trivial-shell)

(</span><span style="color:#b48ead;">defun </span><span style="color:#8fa1b3;">system </span><span style="color:#c0c5ce;">(cmd-str)
 (trivial-shell:shell-command cmd-str))

</span><span style="color:#65737e;">;; split関数を用意
</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">defun </span><span style="color:#8fa1b3;">split </span><span style="color:#c0c5ce;">(x str)
  (</span><span style="color:#b48ead;">let </span><span style="color:#c0c5ce;">((pos (</span><span style="color:#96b5b4;">search</span><span style="color:#c0c5ce;"> x str))
        (size (</span><span style="color:#96b5b4;">length</span><span style="color:#c0c5ce;"> x)))
    (</span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> pos
      (</span><span style="color:#96b5b4;">cons </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">subseq</span><span style="color:#c0c5ce;"> str </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;"> pos)
            (</span><span style="color:#96b5b4;">split</span><span style="color:#c0c5ce;"> x (</span><span style="color:#96b5b4;">subseq</span><span style="color:#c0c5ce;"> str (+ pos size))))
      (</span><span style="color:#96b5b4;">list</span><span style="color:#c0c5ce;"> str))))

</span><span style="color:#65737e;">;; split関数によって改行でリストごとに切っていく
</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">split </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">string </span><span style="color:#d08770;">#\Newline</span><span style="color:#c0c5ce;">) (system &quot;</span><span style="color:#a3be8c;">ls</span><span style="color:#c0c5ce;">&quot;))
</span></code></pre>
<p>これで良さげ。</p>
<h3 id="zhong-warini">終わりに</h3>
<p>自分は今のところCommon LispでUnixコマンドが欲しくなることはあまり無かったのだけど(せいぜいカレントディレクトリを見るくらいで <code>sb-posix:getcwd</code> で解決する)、今日後輩からその手の質問をされて気になったので自分で今回調べてみた。</p>
<p>自分はCommon Lispではアルゴリズムについてよく考える一方でシステムについてあまり触らないので、たまにはこういうのも面白いかもなと思ったり。</p>
<p>勉強になった。</p>

        
      </div>
    </div>
  </div>
</article>


    <hr>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;twitter.com&#x2F;komi_edtr_1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;github.com&#x2F;komi1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.facebook.com&#x2F;1230komi">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yusuke-kominami-0419b1157&#x2F;">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
            </ul>
            <p class="copyright text-muted">
              
              Copyright &copy; Yusuke Kominami. 2020
              
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;jquery.min.js"></script>
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;bootstrap.bundle.min.js"></script>

    <!--Custom scripts for this template-->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;clean-blog.min.js"></script>

    <!--- Additional scripts -->
    
    
  </body>

</html>
