<!DOCTYPE html>
<html lang="en">

  <head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177061519-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-177061519-1');
    </script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Yusuke Kominami's Blog">
    <meta name="author" content="Yusuke Kominami">
    <meta property="og:title" content="Launch Today" />
    <meta property="og:description" content="Yusuke Kominami's Blog" />
    <meta property="og:image" content="https://komi.dev/img/home-bg.jpg" />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:site_name" content="Launch Today" />
    <meta property="og:url" content="https://komi.dev" />
    <meta name="twitter:site" content="@komi_edtr_1230" />
    <meta name="twitter:card" content="summary_large_image">

    <title>Launch Today</title>

    <link rel="icon" href="https://komi.dev/img/favicon.ico" />

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;bootstrap.min.css">
    <!-- Custom fonts for this template -->
    <link href=" https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;all.min.css" rel=" stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
          type='text/css'>
    <link
      href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
      rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;clean-blog.css">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" href="/">Launch Today</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
                aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev">Home</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev&#x2F;about">About</a>
            </li>
            
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    
<!-- Page Header -->
<header class="masthead" style="background-image: url('https:&#x2F;&#x2F;komi.dev&#x2F;img&#x2F;post-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          
<h1>DieselでPostgreSQLに接続</h1>
<span class="meta">Posted on 24 July 2020</span>

        </div>
      </div>
    </div>
  </div>
</header>


    
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <p>最近はずっとRustで簡単なWebアプリを作っているのだけど、PostgreSQLへの接続にちょっと困ったのでメモ。</p>
<h3 id="huan-jing">環境</h3>
<ul>
<li>Rust: 1.45.0</li>
</ul>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">[dependencies]
actix-web = &quot;2.0.0&quot;
actix-rt = &quot;1.1.1&quot;
diesel = { version = &quot;1.4.5&quot;, features = [&quot;postgres&quot;, &quot;chrono&quot;, &quot;r2d2&quot;] }
dotenv = &quot;0.15.0&quot;
serde = &quot;1.0.114&quot;
chrono = { version = &quot;0.4.13&quot;, features = [&quot;serde&quot;] }
r2d2 = &quot;0.8.9&quot;
</span></code></pre><h3 id="yatutakoto">やったこと</h3>
<p>まず最初にDiesel CLIを入れる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">cargo</span><span style="color:#c0c5ce;"> install diesel_cli
</span></code></pre>
<p>その後、作業ディレクトリの中で<code>.env</code>というファイルを作り、その中に</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">DATABASE_URL=postgres://[username]:[password]@localhost/[some_name]
</span></code></pre>
<p>と書き込む。</p>
<p>このとき<code>username</code>と<code>password</code>はローカル環境なら端末のユーザー名とパスワード。</p>
<p>次にPostgreSQLサーバーを立てる。</p>
<p>PostgreSQLのインストールで、Macの場合は</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">brew install postgresql
</span></code></pre>
<p>とする。</p>
<p>これを入れることで</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#65737e;"># PostgreSQLサーバー起動
</span><span style="color:#bf616a;">postgres -D</span><span style="color:#c0c5ce;"> /usr/local/var/postgres

</span><span style="color:#65737e;"># PostgreSQLサーバーへ接続するためのクライアント
</span><span style="color:#c0c5ce;">psql</span><span style="color:#bf616a;"> -h </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">ホスト名</span><span style="color:#b48ead;">]</span><span style="color:#bf616a;"> -U </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">ユーザー名</span><span style="color:#b48ead;">]</span><span style="color:#bf616a;"> -p </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">パスワード</span><span style="color:#b48ead;">] [</span><span style="color:#c0c5ce;">テーブル名</span><span style="color:#b48ead;">]

</span><span style="color:#65737e;"># テーブル作成
</span><span style="color:#c0c5ce;">createdb</span><span style="color:#bf616a;"> -h </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">ホスト名</span><span style="color:#b48ead;">]</span><span style="color:#bf616a;"> -U </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">ユーザー名</span><span style="color:#b48ead;">]</span><span style="color:#bf616a;"> -p </span><span style="color:#b48ead;">[</span><span style="color:#c0c5ce;">パスワード</span><span style="color:#b48ead;">] [</span><span style="color:#c0c5ce;">テーブル名</span><span style="color:#b48ead;">]
</span></code></pre>
<p>などのコマンドが打てる。</p>
<p>ローカル環境の場合はpsqlコマンドの<code>-h</code>や<code>-U</code>などのオプションはデフォルトでlocalhostに繋がるようになっており、手元で簡単に試すのであれば<code>psql [テーブル名]</code>などすれば良い。</p>
<p>さて、今回はDieselでPostgreSQLにつなぐことが目的なので、サーバーを立てる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">postgres -D</span><span style="color:#c0c5ce;"> /usr/local/var/postgres
</span></code></pre>
<p>これを裏でやっておいて、作業ディレクトリでDieselのセットアップをする。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">diesel</span><span style="color:#c0c5ce;"> setup
</span></code></pre>
<p>こうすると先ほど後ろで走らせておいたPostgreSQLサーバーに通信が飛んだのがわかると思う。</p>
<p>あとは<a href="https://diesel.rs/guides/getting-started/">Dieselのチュートリアル</a>の通りにやればよく、まずSQLのコマンドを生成する。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">diesel</span><span style="color:#c0c5ce;"> migration generate create_posts
</span></code></pre>
<p>これをやると作業ディレクトリにmigrationというディレクトリが作られ、中に<code>up.sql</code>と<code>down.sql</code>というファイルが作られる。</p>
<p>それぞれ</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">CREATE TABLE </span><span style="color:#8fa1b3;">posts</span><span style="color:#c0c5ce;"> (
  id </span><span style="color:#b48ead;">SERIAL PRIMARY KEY</span><span style="color:#c0c5ce;">,
  title </span><span style="color:#b48ead;">VARCHAR </span><span style="color:#c0c5ce;">NOT </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">,
  body </span><span style="color:#b48ead;">TEXT </span><span style="color:#c0c5ce;">NOT </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">,
  published </span><span style="color:#b48ead;">BOOLEAN </span><span style="color:#c0c5ce;">NOT </span><span style="color:#d08770;">NULL </span><span style="color:#b48ead;">DEFAULT </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">f</span><span style="color:#c0c5ce;">&#39;
)
</span></code></pre><pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">DROP TABLE</span><span style="color:#c0c5ce;"> posts
</span></code></pre>
<p>と書き込む。</p>
<p>あとは</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#bf616a;">diesel</span><span style="color:#c0c5ce;"> migration run
</span></code></pre>
<p>とコマンドを打てば、裏側で走らせてるPostgreSQLサーバーが走ってCREATE TABLEしてくれる。</p>
<h3 id="fan-sheng">反省</h3>
<p>最初に作業をしていたとき、ローカルでPostgreSQLサーバーを立てるのがめんどくさくて、<code>.env</code>の中を</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">DATABASE_URL=&quot;test.db&quot;
</span></code></pre>
<p>としており、実際に<code>diesel setup</code>などをすると若干怪しい動きをしつつも作業ディレクトリに<code>test.db</code>というファイルが生成されていたのでイケると勝手に勘違いしていた。</p>
<p>その後、作業を続けてActix-webでHTTPサーバー立てようとしたときデータベースへの繋ぎ込みがうまくいかないことが原因となってHTTPサーバー自体も立ち上がらず...</p>
<p>そんなこんなでかなり時間を食ってしまった(CircleCIもめちゃくちゃコケた)ので、これからはローカル開発でもサボらずにサーバーを立てようと思う。</p>

        
      </div>
    </div>
  </div>
</article>


    <hr>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;twitter.com&#x2F;komi_edtr_1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;github.com&#x2F;komi1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.facebook.com&#x2F;1230komi">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yusuke-kominami-0419b1157&#x2F;">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
            </ul>
            <p class="copyright text-muted">
              
              Copyright &copy; Yusuke Kominami. 2020
              
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;jquery.min.js"></script>
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;bootstrap.bundle.min.js"></script>

    <!--Custom scripts for this template-->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;clean-blog.min.js"></script>

    <!--- Additional scripts -->
    
    
  </body>

</html>
