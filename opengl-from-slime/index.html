<!DOCTYPE html>
<html lang="en">

  <head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177061519-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-177061519-1');
    </script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Yusuke Kominami's Blog">
    <meta name="author" content="Yusuke Kominami">
    <meta property="og:title" content="Launch Today" />
    <meta property="og:description" content="Yusuke Kominami's Blog" />
    <meta property="og:image" content="https://komi.dev/img/home-bg.jpg" />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:site_name" content="Launch Today" />
    <meta property="og:url" content="https://komi.dev" />
    <meta name="twitter:site" content="@komi_edtr_1230" />
    <meta name="twitter:card" content="summary_large_image">

    <title>Launch Today</title>

    <link rel="icon" href="https://komi.dev/img/favicon.ico" />

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;bootstrap.min.css">
    <!-- Custom fonts for this template -->
    <link href=" https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;all.min.css" rel=" stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
          type='text/css'>
    <link
      href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
      rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;clean-blog.css">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" href="/">Launch Today</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
                aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev">Home</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev&#x2F;about">About</a>
            </li>
            
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    
<!-- Page Header -->
<header class="masthead" style="background-image: url('https:&#x2F;&#x2F;komi.dev&#x2F;img&#x2F;post-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          
<h1>SLIMEからOpenGLを触る</h1>
<span class="meta">Posted on  1 December 2019</span>

        </div>
      </div>
    </div>
  </div>
</header>


    
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <p>Lispの開発においてSLIMEは必須のものであり生命線。</p>
<p>これがあるとないとでは開発効率は10倍以上は変わるだろうし、LispをLispたらしめている要因の一つであるのがSLIMEなんだと思う。</p>
<p>そんなSLIMEを使って現在は開発を進めているのだけれど、実は一つ問題が発生していた。</p>
<p>現在趣味でCommon Lispでグラフィック系のものを作っているのだけれど、SLIMEからだとウィンドウが立ち上がらないのである。</p>
<p>これがSLIMEで長いこと目の上のタンコブであったわけだけど、今回なんとか解決したのでメモ書き。</p>
<h3 id="gai-yao">概要</h3>
<p>環境はmacOS CatalinaでSBCLのバージョンは1.5.7.55、Emacsは26.3。</p>
<p>そもそもSLIMEとはEmacs起動中に裏側でLispのREPLを起動したサーバーを立てておいて、それをエディタからそのREPLに通信するという方式をとっている。</p>
<p>今回問題が起きていたのは、SLIMEのREPLサーバーに対しての通信方式で、デフォルトだと通信に個別のスレッドを使用する方法を採用している。</p>
<p>これだとREPL上の白黒のデータを動かすようなスレッドはちゃんと動いてもグラフィック系のような別ウィンドウを立ち上げるものはうまくいかない(個別のスレッドなのでデータのやり取りが途切れてしまう)。</p>
<p>なので、SLIMEの通信方式をデフォルトの個別のスレッドを使用する方式からループアプローチに変更する必要がある。</p>
<h3 id="kodo">コード</h3>
<p>自分の環境では、Emacsの設定ファイルはホームディレクトリに設定ファイルを格納したファイルを入れており、SLIMEはそのディレクトリ内に格納している。</p>
<p>実際、</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">~/.emacs.d
├── init.el
├── slime/
│   ├── swank.lisp
│   ├── README.md
...
</span></code></pre>
<p>というような構造をとっている。</p>
<p>SLIMEの利用に関しては<code>init.el</code>の中にて<code>(add-to-list 'load-path (expand-file-name &quot;~/.emacs.d/slime&quot;))</code>としてSLIMEのファイルをロードしている。</p>
<p>さて、今回変更を書き加えるのはこの<code>~/.emacs.d/slime/</code>内の<code>swank.lisp</code>。</p>
<p>まず、先ほど述べた通り、SLIMEの通信方式を変える。</p>
<p>この<code>swank.lisp</code>の130行目あたりから始まるConnectionのところにて、<code>*communication-style*</code>を<code>nil</code>から<code>:fd-handler</code>にする。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">defstruct </span><span style="color:#c0c5ce;">(connection
             (:constructor %make-connection)
             (:conc-name connection.)
             (:</span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">-function </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">-connection))
  </span><span style="color:#65737e;">;; The listening socket. (usually closed)
  </span><span style="color:#c0c5ce;">(socket           (missing-arg) :type </span><span style="color:#d08770;">t</span><span style="color:#c0c5ce;"> :</span><span style="color:#96b5b4;">read</span><span style="color:#c0c5ce;">-only </span><span style="color:#d08770;">t</span><span style="color:#c0c5ce;">)
  </span><span style="color:#65737e;">;; Character I/O stream of socket connection.  Read-only to avoid
  ;; race conditions during initialization.
  </span><span style="color:#c0c5ce;">(socket-io        (missing-arg) :type stream :</span><span style="color:#96b5b4;">read</span><span style="color:#c0c5ce;">-only </span><span style="color:#d08770;">t</span><span style="color:#c0c5ce;">)
  </span><span style="color:#65737e;">;; Optional dedicated output socket (backending `user-output&#39; slot).
  ;; Has a slot so that it can be closed with the connection.
  </span><span style="color:#c0c5ce;">(dedicated-output </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :type (or stream </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">))
  </span><span style="color:#65737e;">;; Streams that can be used for user interaction, with requests
  ;; redirected to Emacs.
  </span><span style="color:#c0c5ce;">(user-input       </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :type (or stream </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">))
  (user-output      </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :type (or stream </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">))
  (user-io          </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :type (or stream </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">))
  </span><span style="color:#65737e;">;; Bindings used for this connection (usually streams)
  </span><span style="color:#c0c5ce;">(env &#39;() :type </span><span style="color:#96b5b4;">list</span><span style="color:#c0c5ce;">)
  </span><span style="color:#65737e;">;; A stream that we use for *trace-output*; if nil, we user user-output.
  </span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">trace</span><span style="color:#c0c5ce;">-output     </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :type (or stream </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">))
  </span><span style="color:#65737e;">;; A stream where we send REPL results.
  </span><span style="color:#c0c5ce;">(repl-results     </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :type (or stream </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">))
  </span><span style="color:#65737e;">;; Cache of macro-indentation information that has been sent to Emacs.
  ;; This is used for preparing deltas to update Emacs&#39;s knowledge.
  ;; Maps: symbol -&gt; indentation-specification
  </span><span style="color:#c0c5ce;">(indentation-cache (</span><span style="color:#96b5b4;">make-hash-table</span><span style="color:#c0c5ce;"> :test &#39;eq) :type hash-table)
  </span><span style="color:#65737e;">;; The list of packages represented in the cache:
  </span><span style="color:#c0c5ce;">(indentation-cache-packages &#39;())
  </span><span style="color:#65737e;">;; The communication style used.
  </span><span style="color:#c0c5ce;">(communication-style :fd-handler :type (</span><span style="color:#96b5b4;">member </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;"> :spawn :sigio :fd-handler))  </span><span style="color:#65737e;">;; この部分！
  </span><span style="color:#c0c5ce;">)
</span></code></pre>
<p>次に、<code>swank.lisp</code>の最後の方にて、<code>(defun before-init ...</code>に<code>(setq *communication-style* nil)</code>と書き加える。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">defun </span><span style="color:#8fa1b3;">before-init </span><span style="color:#c0c5ce;">(version </span><span style="color:#96b5b4;">load</span><span style="color:#c0c5ce;">-path)
  (</span><span style="color:#96b5b4;">pushnew</span><span style="color:#c0c5ce;"> :swank *</span><span style="color:#bf616a;">features</span><span style="color:#c0c5ce;">*)
  (</span><span style="color:#96b5b4;">setq </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">swank-wire-protocol-version</span><span style="color:#c0c5ce;">* version)
  (</span><span style="color:#96b5b4;">setq </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">load-path</span><span style="color:#c0c5ce;">* </span><span style="color:#96b5b4;">load</span><span style="color:#c0c5ce;">-path)
  (</span><span style="color:#96b5b4;">setq </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">communication-style</span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">nil</span><span style="color:#c0c5ce;">))  </span><span style="color:#65737e;">;; この部分！
</span></code></pre>
<p>この2つをやれば動くようになった。</p>
<p>果たしてこれが正しいのかはわからないけど、とにかく動くようになって作業が捗るようになったので良いと思う。</p>
<h3 id="matome">まとめ</h3>
<p>今回はSLIMEの設定ファイルを直接いじることによってSLIMEからCL-OpenGLを叩けるようにした。</p>
<p>なんとか解決したので、ようやく開発にスピード感が出てくると思われる。</p>
<p>がんばっていきたい。</p>

        
      </div>
    </div>
  </div>
</article>


    <hr>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;twitter.com&#x2F;komi_edtr_1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;github.com&#x2F;komi1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.facebook.com&#x2F;1230komi">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yusuke-kominami-0419b1157&#x2F;">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
            </ul>
            <p class="copyright text-muted">
              
              Copyright &copy; Yusuke Kominami. 2020
              
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;jquery.min.js"></script>
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;bootstrap.bundle.min.js"></script>

    <!--Custom scripts for this template-->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;clean-blog.min.js"></script>

    <!--- Additional scripts -->
    
    
  </body>

</html>
