<!DOCTYPE html>
<html lang="en">

  <head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177061519-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-177061519-1');
    </script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Yusuke Kominami's Blog">
    <meta name="author" content="Yusuke Kominami">
    <meta property="og:title" content="Launch Today" />
    <meta property="og:description" content="Yusuke Kominami's Blog" />
    <meta property="og:image" content="https://komi.dev/img/home-bg.jpg" />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:site_name" content="Launch Today" />
    <meta property="og:url" content="https://komi.dev" />
    <meta name="twitter:site" content="@komi_edtr_1230" />
    <meta name="twitter:card" content="summary_large_image">

    <title>Launch Today</title>

    <link rel="icon" href="https://komi.dev/img/favicon.ico" />

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;bootstrap.min.css">
    <!-- Custom fonts for this template -->
    <link href=" https:&#x2F;&#x2F;komi.dev&#x2F;css&#x2F;all.min.css" rel=" stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
          type='text/css'>
    <link
      href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
      rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;komi.dev&#x2F;clean-blog.css">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" href="/">Launch Today</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
                aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev">Home</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link"
                 href="https:&#x2F;&#x2F;komi.dev&#x2F;about">About</a>
            </li>
            
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    
<!-- Page Header -->
<header class="masthead" style="background-image: url('https:&#x2F;&#x2F;komi.dev&#x2F;img&#x2F;post-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          
<h1>Clojureのリーダマクロをざざっと理解する</h1>
<span class="meta">Posted on 30 October 2019</span>

        </div>
      </div>
    </div>
  </div>
</header>


    
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <p>引き続きClojureのお勉強。</p>
<p>前回はClojureで簡単なメッセージを通信するHTTPサーバーを立てるところまでやった。</p>
<p>今回はそこから発展してミドルウェアの作成などをやろう.....と思っていたのだけれど、色々なWebサイトを参考にしてちょこちょこコードを読んでいたところリーダマクロがわからず<b>なんだこれ...?</b>となることが多々あった。</p>
<p>そこで今回はClojureでサーバーを構築する云々から一度離れてClojureのリーダマクロをささっとまとめておこうと思う。</p>
<h3 id="ridamakurotute">リーダマクロって？</h3>
<p>リーダマクロは接頭辞や接尾辞に何か文字を付け加えることで別の式に展開することを可能にするマクロ文字のこと。</p>
<p>例えばラムダ式の定義においてClojureだと</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">user=&gt;  ((</span><span style="color:#b48ead;">fn </span><span style="color:#c0c5ce;">[x y] (</span><span style="color:#bf616a;">+</span><span style="color:#c0c5ce;"> x x)) </span><span style="color:#d08770;">10 20</span><span style="color:#c0c5ce;">)
</span><span style="color:#65737e;">;; 30
</span></code></pre>
<p>だったりするが、これはリーダマクロ<code>#()</code>を使うことで</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">user=&gt; (#(</span><span style="color:#bf616a;">+</span><span style="color:#c0c5ce;"> %1 %2) </span><span style="color:#d08770;">10 20</span><span style="color:#c0c5ce;">)
</span><span style="color:#65737e;">;; 30
</span></code></pre>
<p>という感じになる。</p>
<p>ちなみにこの例での<code>%</code>は引数の順番を表し、<code>%1</code>は第一引数のこと。第一引数は<code>%</code>としてもオッケー。</p>
<p>こんな感じのマクロ文字がたくさんあるのだけれど、Clojure言語の実装を見てるとだいたいお気持ちが掴めてくるので以下ではそこらへんについてまとめていく。</p>
<h3 id="clojureyan-yu-nososukodowojian-ru">Clojure言語のソースコードを見る</h3>
<p>ClojureはJavaで実装されていて、リーダマクロあたりについては以下のあたりのコードに実装されている。</p>
<p>[https://github.com/clojure/clojure/blob/master/src/jvm/clojure/lang/LispReader.java#L90-L120:embed:cite]</p>
<p>中身はこうなっている。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">	 macros[&#39;</span><span style="color:#a3be8c;">&quot;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">StringReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CommentReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#96b5b4;">\&#39;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">WrappingReader</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">QUOTE</span><span style="color:#c0c5ce;">);
	macros[&#39;</span><span style="color:#a3be8c;">@</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">WrappingReader</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">DEREF</span><span style="color:#c0c5ce;">);</span><span style="color:#65737e;">//new DerefReader();
</span><span style="color:#c0c5ce;">	macros[&#39;</span><span style="color:#a3be8c;">^</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">MetaReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">`</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">SyntaxQuoteReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">~</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnquoteReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">(</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ListReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">)</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnmatchedDelimiterReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">[</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">VectorReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">]</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnmatchedDelimiterReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">{</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">MapReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">}</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnmatchedDelimiterReader</span><span style="color:#c0c5ce;">();
</span><span style="color:#65737e;">//	macros[&#39;|&#39;] = new ArgVectorReader();
</span><span style="color:#c0c5ce;">	macros[&#39;</span><span style="color:#96b5b4;">\\</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CharacterReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">%</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ArgReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">#</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">DispatchReader</span><span style="color:#c0c5ce;">();
</span></code></pre>
<p>これを見てみると<code>#</code>にディスパッチマクロが割り当てられており、ディスパッチマクロについては以下の通りに定義されている。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">	 dispatchMacros[&#39;</span><span style="color:#a3be8c;">^</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">MetaReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">#</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">SymbolicValueReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#96b5b4;">\&#39;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">VarReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">&quot;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">RegexReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">(</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">FnReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">{</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">SetReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">=</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">EvalReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">!</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CommentReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">&lt;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">UnreadableReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">_</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">DiscardReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">?</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ConditionalReader</span><span style="color:#c0c5ce;">();
	dispatchMacros[&#39;</span><span style="color:#a3be8c;">:</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">NamespaceMapReader</span><span style="color:#c0c5ce;">();
</span></code></pre>
<p>ディスパッチマクロとは、この場合<b>マクロ文字<code>#</code>以降では別の式に変換するよー</b>というような機能を持ったマクロで、リーダマクロの二段重ねくらいの認識で大丈夫なはず。</p>
<p>さて、早速中身を見ていこうと思う。</p>
<h4 id="daburukuotesiyon-tosemikoron">ダブルクオーテーション<code>&quot;</code>とセミコロン<code>;</code></h4>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">	 macros[&#39;</span><span style="color:#a3be8c;">&quot;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">StringReader</span><span style="color:#c0c5ce;">();
	macros[&#39;</span><span style="color:#a3be8c;">;</span><span style="color:#c0c5ce;">&#39;] = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CommentReader</span><span style="color:#c0c5ce;">();
</span></code></pre>
<p>これについては変数名の通りで、<code>&quot;</code>は文字列を認識し<code>;</code>はコメントにするものである。</p>
<p>実際にClojureのコードでは</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">println </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Hi Clojure !</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#65737e;">;; (println &quot;This is a just comment&quot;)
</span></code></pre>
<p>という感じになっている。</p>
<h4 id="singurukuotesiyon">シングルクオーテーション<code>\'</code></h4>
<p><s>次の<code>\'</code>はシングルクオーテーションで、これはLisperにはお馴染みのシンボルを表す。</s></p>
<p>ClojureのシンボルはCommon Lispとは挙動が異なり、Common Lispではシンボルは値を内包していてシンボルと値が同一であるのに対し、Clojureはシンボルと値がそれぞれ独立で、それぞれを名前空間がマッピングしているという構造を持っているらしい。</p>
<p>変数がunboundになることを想定したときシンボルと値は分けた方が都合がよいのでこのような構造をとっているらしく、ここらへんの挙動についてはRich HickeyのSimple made easyという哲学に基づいているもの、なんだとか。</p>
<p>少し難しいが、ここらへんも勉強していかないとなぁという感じ。</p>
<p>ご指摘いただいた<a href="https://twitter.com/lagenorhynque">@lagenorhynque</a>さんありがとうございました！！！</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">x </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
(</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;"> x) </span><span style="color:#65737e;">; =&gt; 10
(println &#39;x) ; =&gt; x
(println (quote x)) ; =&gt; x
</span></code></pre><h4 id="atutomaku">アットマーク<code>@</code></h4>
<p>さて、次の<code>@</code>はCommon Lispの畑からやってきた人間にとってはあまり見慣れないもの。</p>
<p>Clojureには並行処理をサポートしていて、その際に変数を参照して展開することをこの<code>@</code>は行ってくれる。</p>
<p><b>ref</b>が参照なら<b>deref</b>が参照はずし(展開するといった方が正確？)</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">x </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ref </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">))
(</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;"> x) </span><span style="color:#65737e;">; =&gt; #object[clojure.lang.Ref 0x17aabeae {:status :ready, :val 10}]
(println @x) ; =&gt; 10
(println (deref x)) ; =&gt; 10
</span></code></pre>
<p>ちなみにこの<code>@</code>は遅延評価でも有効らしく、</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">x </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">delay </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">))
(</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;"> x) </span><span style="color:#65737e;">; =&gt; #object[clojure.lang.Ref 0x17aabeae {:status :pending, :val 10}]
(println @x) ; =&gt; 10
(println x) ; =&gt; #object[clojure.lang.Ref 0x17aabeae {:status :ready, :val 10}]
</span></code></pre>
<p>この場合、遅延評価によって実行の前後でステータスがpendingからreadyに変化しているに注意。</p>
<h4 id="kiyaretuto">キャレット<code>^</code></h4>
<p>これもまたCommon Lisperには見慣れないもので、Clojureでは実際の変数に対してコンパイル時の型の情報や名前空間などのメタ情報を付加することができる。</p>
<p>実際、変数をprivateかpublicかのアクセス制限をかけるとき</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#c0c5ce;">^</span><span style="color:#d08770;">:private </span><span style="color:#8fa1b3;">x </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
(</span><span style="color:#b48ead;">def </span><span style="color:#c0c5ce;">^{</span><span style="color:#d08770;">:private true</span><span style="color:#c0c5ce;">} </span><span style="color:#8fa1b3;">x </span><span style="color:#d08770;">10 </span><span style="color:#65737e;">;; 上と同じ
</span></code></pre>
<p>としたり、もしくは型の情報(型ヒント)を明記するとき</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">defn- </span><span style="color:#8fa1b3;">foo </span><span style="color:#c0c5ce;">[^long i ^long j] (</span><span style="color:#bf616a;">+</span><span style="color:#c0c5ce;"> i j))
</span></code></pre>
<p>とすればオッケー。</p>
<p>実際にメタ情報を見ようとするなら</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#c0c5ce;">^</span><span style="color:#d08770;">:private </span><span style="color:#8fa1b3;">x </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
(</span><span style="color:#bf616a;">meta </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">var</span><span style="color:#c0c5ce;"> x)) 
</span><span style="color:#65737e;">;; {:private true, :line 1, :column 1, :file &quot;/private/var/...&quot;
(meta #&#39;x)
</span></code></pre>
<p>として見れる。</p>
<p>ここで変数xについて<code>'x</code>がただのシンボルだが<code>#'x</code>はまた特殊で、Clojure では変数や関数の実体への参照として var というものがある。</p>
<p>よってREPLにて</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">x </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
(</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;"> x)
(</span><span style="color:#bf616a;">println </span><span style="color:#c0c5ce;">&#39;x)
(</span><span style="color:#bf616a;">println </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">var</span><span style="color:#c0c5ce;"> x))
</span></code></pre>
<p>として見てみると<code>(var x)</code>が名前空間から参照しているのがわかると思う。</p>
<p>ここらへんは解説するとクソ長くなるのと自分がまだ完全理解してないのでここらへんで切り上げることにする。</p>
<h4 id="batukukuotesiyon-totiruda">バッククオーテーション<code>`</code>とチルダ<code>~</code></h4>
<p>バッククオーテーションは式全体をシンボル化し、<code>~</code>はクオートを外す。</p>
<p>Common Lispだとアンクオートはカンマ<code>,</code>だったけどClojureではチルダ<code>~</code>になっているらしい。</p>
<p>さて、ここらへんは難しくないのでささっと。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">x </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
(</span><span style="color:#bf616a;">println </span><span style="color:#c0c5ce;">`(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;"> x)) </span><span style="color:#65737e;">; =&gt; (1 x)
(println `(1 ~x)) ; =&gt; (1 10)
</span></code></pre>
<p>ちなみにここでクオートされたリストに対してアットマーク<code>@</code>を組み合わせると括弧を外すことができる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">y </span><span style="color:#c0c5ce;">&#39;(</span><span style="color:#d08770;">2 3</span><span style="color:#c0c5ce;">))
(</span><span style="color:#bf616a;">println </span><span style="color:#c0c5ce;">`(</span><span style="color:#d08770;">1 </span><span style="color:#c0c5ce;">~@y) </span><span style="color:#65737e;">; =&gt; (1 2 3)
</span></code></pre>
<p>なんでこんなことができるのかというと、<code>~@</code>がUnquoted Splicingというリーダマクロだから。</p>
<p>Lispすごい。</p>
<h4 id="gua-hu-toka">括弧とか<code>(</code> <code>)</code> <code>{</code> <code>}</code> <code>[</code> <code>]</code></h4>
<p>ここらへんはリストとか集合とかベクトルとかのデータ型。</p>
<p>めんどくさいので省略。</p>
<h4 id="siyapu-tiruda">シャープ+チルダ<code>#^</code></h4>
<p>メタデータを付加することができるが、先述のキャレット<code>^</code>単体と何が違うとかというと、<code>#^</code>では独自のkey/valueをメタデータとして付与できる。</p>
<p>...というのがClojure1.1とか1.2とかあたりの話らしい。</p>
<p>なんでも、Clojure1.1ではキャレット<code>^</code>は非推奨で<code>#^</code>を推奨していたらしい。</p>
<p>しかし手元で試してみたら普通にキャレット<code>^</code>単体でも独自のkey/valueがメタデータとして付与できて、なんだかよくわからない。</p>
<p>どういう使い分けなんだろう？</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">def </span><span style="color:#c0c5ce;">#^{</span><span style="color:#d08770;">:fuck-kyoto-univ 114514</span><span style="color:#c0c5ce;">} x </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
(</span><span style="color:#bf616a;">meta </span><span style="color:#c0c5ce;">#&#39;x)
</span></code></pre>
<p>うーん、難しい。</p>
<blockquote>
<p>追記. Clojure1.10.1では<code>#^</code>はdeprecatedとなっているらしく、挙動自体は<code>#^</code>と<code>^</code>は変わらないらしい。</p>
</blockquote>
<h4 id="siyapu-siyapu">シャープ+シャープ<code>##</code></h4>
<p>これはInfなどを表すものらしい。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">/ </span><span style="color:#d08770;">1.0 0.0</span><span style="color:#c0c5ce;">) </span><span style="color:#65737e;">; =&gt; ##Inf
</span></code></pre><h4 id="siyapu-singurukuotesiyon">シャープ+シングルクオーテーション<code>#'</code></h4>
<p>これは<code>(var x)</code>と同じこと。</p>
<p>さっきやった。</p>
<h4 id="siyapu-daburukuotesiyon">シャープ+ダブルクオーテーション<code>#&quot;...&quot;</code></h4>
<p>はい！出ました！みんな大好き正規表現！！！</p>
<p>Pythonだと最初に<code>import re</code>とかやって正規表現ライブラリを引っ張ってきて...みたいな感じでやるけどClojureではデフォルトで正規表現を使えるのでなんと幸せなことだろうか....!!</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">re-find </span><span style="color:#c0c5ce;">#&quot;</span><span style="color:#b48ead;">\d</span><span style="color:#c0c5ce;">+&quot; &quot;</span><span style="color:#a3be8c;">abc12345def</span><span style="color:#c0c5ce;">&quot;) </span><span style="color:#65737e;">; =&gt; &quot;12345&quot;
(re-matches #&quot;hello, (.*)&quot; &quot;hello, world&quot;) ; =&gt; [&quot;hello, world&quot; &quot;world&quot;]
</span></code></pre>
<p>中の正規表現エンジンが先読みとか再帰とかのイケてるやつまでサポートしてるのかは知らないけど、Javaの正規表現のやつをラップしてる感じらしいので多分サポートしてるはず。</p>
<h4 id="siyapu-gua-hu">シャープ+括弧<code>#(...)</code></h4>
<p>これはこのエントリーの最初の例にやったので省略。</p>
<h4 id="siyapu-bo-gua-hu">シャープ+波括弧<code>#{...}</code></h4>
<p>集合ね。省略。</p>
<h4 id="siyapu-ikoru">シャープ+イコール<code>#=</code></h4>
<p>これは<code>#=</code>に続くフォームを評価するもので</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">#=(</span><span style="color:#bf616a;">+ </span><span style="color:#d08770;">1 2 3</span><span style="color:#c0c5ce;">) </span><span style="color:#65737e;">; =&gt; 6
(read-string &quot;#=(+ 1 2 3)&quot;) ; =&gt; 6
</span></code></pre>
<p>というような感じ。</p>
<p>一つ注意点として<code>*read-eval*</code>がfalseになっている場合このリードマクロは機能しない。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">binding </span><span style="color:#c0c5ce;">[*read-eval* </span><span style="color:#d08770;">false</span><span style="color:#c0c5ce;">] (</span><span style="color:#bf616a;">read-string </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">#=(+ 1 2 3)</span><span style="color:#c0c5ce;">&quot;)) 
</span><span style="color:#65737e;">; =&gt; 計算できませーん
</span></code></pre><h4 id="siyapu-ekusukuramesiyonmaku">シャープ+エクスクラメーションマーク<code>#!</code></h4>
<p>コメントになるらしい。</p>
<p>シェバンとかで使えそう。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#65737e;">#!(+ 1 2 3) ; =&gt; 反応なし
</span></code></pre><h4 id="siyapu-xiao-narida-nari">シャープ+小なり大なり<code>#&lt;...&gt;</code></h4>
<p>これは以下のformを例外をThrowしてくれるらしい。</p>
<p>例えば<code>(atom 42)</code>をREPLで評価すると<code>#&lt;Atom: 42&gt;</code>とprintされ、これはUnreadableで評価されないものなんだよー的なことが他のサイトに書いてあったけどなんだかよくわからない。</p>
<p>参照 : <a href="https://cljs.github.io/api/syntax/unreadable">CLJSのUnreadbleのページにて</a></p>
<h4 id="siyapu-andaba">シャープ+アンダーバー<code>#_</code></h4>
<p>これはコメントの扱いになるらしい。</p>
<p>つまり読まれず評価されない。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">#_(</span><span style="color:#bf616a;">+ </span><span style="color:#d08770;">1 2 3</span><span style="color:#c0c5ce;">) </span><span style="color:#65737e;">; =&gt; 反応なし
</span></code></pre><h4 id="siyapu-kuesutiyonmaku">シャープ+クエスチョンマーク<code>#?</code></h4>
<p>環境非依存なコードを書くために、環境ごとに条件分岐をしてくれるものらしい。</p>
<p>どういうことかというと、例えば以下のコードで</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">#?(</span><span style="color:#d08770;">:clj </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Hi !</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#d08770;">:cljs </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Hello !</span><span style="color:#c0c5ce;">&quot;)
</span></code></pre>
<p>実行がClojureなら<code>Hi !</code>とprintされ、ClojureScriptなら<code>Hello !</code>とprintされるらしい。</p>
<p>そういえばClojureScriptなんてものあったな....(Clojureに入門してそこまで時間たってない顔)</p>
<p>とりあえずこのディスパッチマクロはそういうものらしい。</p>
<h4 id="siyapu-koron">シャープ+コロン<code>#:</code></h4>
<p>まず、コロン<code>:</code>はキーワード指定子であり、コロン+コロン<code>::</code>は現在の名前空間にキーワードを紐付けるものである。</p>
<p>その前提で、シャープ+コロン<code>#:</code>は名前空間にキーワードをまとめて紐づけることができる。</p>
<p>具体的に、</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">#</span><span style="color:#d08770;">:person</span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:first </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Han</span><span style="color:#c0c5ce;">&quot;
         </span><span style="color:#d08770;">:last </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Solo</span><span style="color:#c0c5ce;">&quot;
         </span><span style="color:#d08770;">:ship </span><span style="color:#c0c5ce;">#</span><span style="color:#d08770;">:ship</span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:name </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Millennium Falcon</span><span style="color:#c0c5ce;">&quot;
                      </span><span style="color:#d08770;">:model </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">YT-1300f light freighter</span><span style="color:#c0c5ce;">&quot;}}
</span></code></pre>
<p>は以下のように読み替えられる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:person/first </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Han</span><span style="color:#c0c5ce;">&quot;
 </span><span style="color:#d08770;">:person/last </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Solo</span><span style="color:#c0c5ce;">&quot;
 </span><span style="color:#d08770;">:person/ship </span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:ship/name </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Millennium Falcon</span><span style="color:#c0c5ce;">&quot;
               </span><span style="color:#d08770;">:ship/model </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">YT-1300f light freighter</span><span style="color:#c0c5ce;">&quot;}}
</span></code></pre>
<p>さて、コロン+コロン<code>::</code>は現在の名前空間にキーワードを紐付けるので<code>#::</code>も同様に</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ns</span><span style="color:#c0c5ce;"> rebel.core
  (</span><span style="color:#d08770;">:require
    </span><span style="color:#c0c5ce;">[rebel.person </span><span style="color:#d08770;">:as</span><span style="color:#c0c5ce;"> p]
    [rebel.ship   </span><span style="color:#d08770;">:as</span><span style="color:#c0c5ce;"> s] ))

#</span><span style="color:#d08770;">::p</span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:first </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Han</span><span style="color:#c0c5ce;">&quot;
     </span><span style="color:#d08770;">:last </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Solo</span><span style="color:#c0c5ce;">&quot;
     </span><span style="color:#d08770;">:ship </span><span style="color:#c0c5ce;">#</span><span style="color:#d08770;">::s</span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:name </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Millennium Falcon</span><span style="color:#c0c5ce;">&quot;
                </span><span style="color:#d08770;">:model </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">YT-1300f light freighter</span><span style="color:#c0c5ce;">&quot;}}
</span></code></pre>
<p>は以下の通りとなる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:rebel.person/first </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Han</span><span style="color:#c0c5ce;">&quot;
 </span><span style="color:#d08770;">:rebel.person/last </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Solo</span><span style="color:#c0c5ce;">&quot;
 </span><span style="color:#d08770;">:rebel.person/ship </span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">:rebel.ship/name </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Millennium Falcon</span><span style="color:#c0c5ce;">&quot;
                     </span><span style="color:#d08770;">:rebel.ship/model </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">YT-1300f light freighter</span><span style="color:#c0c5ce;">&quot;}}
</span></code></pre><h3 id="matome">まとめ</h3>
<p>意外とリーダマクロはそこまで多くないらしい。</p>
<p>ただ、いくつか挙動が謎なものもあって、自分でコードを書くときは不安だけどコードを読む分には最低限は大丈夫そう。</p>
<p>ところでメタデータで型情報を渡したらコンパイルとか速くなるものなんだろうか？</p>
<p>あくまで型ヒントみたいな感じでPythonのType Hintingみたいにコードに虚無を植え付けるだけとかだと感情も虚無になってしまうので....</p>
<p>とりあえずだんだんとClojureが楽しくなってきた。</p>
<p>さあこれからもがんばるぞい！</p>

        
      </div>
    </div>
  </div>
</article>


    <hr>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;twitter.com&#x2F;komi_edtr_1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;github.com&#x2F;komi1230">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.facebook.com&#x2F;1230komi">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
              <li class="list-inline-item">
                <a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yusuke-kominami-0419b1157&#x2F;">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              
            </ul>
            <p class="copyright text-muted">
              
              Copyright &copy; Yusuke Kominami. 2020
              
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;jquery.min.js"></script>
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;bootstrap.bundle.min.js"></script>

    <!--Custom scripts for this template-->
    <script src="https:&#x2F;&#x2F;komi.dev&#x2F;js&#x2F;clean-blog.min.js"></script>

    <!--- Additional scripts -->
    
    
  </body>

</html>
