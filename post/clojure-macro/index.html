<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Launch Today"><meta property="og:type" content="article"><meta property="og:image" content="http://example.org//img/home.jpg"><meta property="twitter:image" content="http://example.org//img/home.jpg"><meta name=title content="Clojureのリーダマクロをざざっと理解する"><meta property="og:title" content="Clojureのリーダマクロをざざっと理解する"><meta property="twitter:title" content="Clojureのリーダマクロをざざっと理解する"><meta name=description content="技術的なことやプライベートなことについてまとめたりしていきます。"><meta property="og:description" content="技術的なことやプライベートなことについてまとめたりしていきます。"><meta property="twitter:description" content="技術的なことやプライベートなことについてまとめたりしていきます。"><meta property="twitter:card" content="summary"><meta name=keyword content="Yusuke Kominami, 小南佑介, 小南 佑介, Rust, Emacs, Lisp, Web, Machine Learning, 機械学習"><link rel="shortcut icon" href=/img/favicon.ico><title>Clojureのリーダマクロをざざっと理解する-Kominami Blog</title><link rel=canonical href=/post/clojure-macro/><link rel=stylesheet href=/css/iDisqus.min.css><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/zanshang.css><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=http://example.org/css/custom-font.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/>Launch Today</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/top/about/>ABOUT</a></li></ul></div></div></div></nav><script>var $body=document.body;var $toggle=document.querySelector('.navbar-toggle');var $navbar=document.querySelector('#huxblog_navbar');var $collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic)
function handleMagic(e){if($navbar.className.indexOf('in')>0){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf('in')<0){$collapse.style.height="0px"}},400)}else{$collapse.style.height="auto"
$navbar.className+=" in";}}</script><style type=text/css>header.intro-header{background-image:url(/img/home.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags></div><h1>Clojureのリーダマクロをざざっと理解する</h1><h2 class=subheading></h2><span class=meta>Posted by
Launch Today
on
Wednesday, October 30, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
post-container"><header><h2>TOC</h2></header><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav><p>引き続きClojureのお勉強。</p><p>前回はClojureで簡単なメッセージを通信するHTTPサーバーを立てるところまでやった。</p><p>今回はそこから発展してミドルウェアの作成などをやろう&mldr;..と思っていたのだけれど、色々なWebサイトを参考にしてちょこちょこコードを読んでいたところリーダマクロがわからずなんだこれ&mldr;?となることが多々あった。</p><p>そこで今回はClojureでサーバーを構築する云々から一度離れてClojureのリーダマクロをささっとまとめておこうと思う。</p><h3 id=リーダマクロって>リーダマクロって？</h3><p>リーダマクロは接頭辞や接尾辞に何か文字を付け加えることで別の式に展開することを可能にするマクロ文字のこと。</p><p>例えばラムダ式の定義においてClojureだと</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#8be9fd;font-style:italic>user=&gt;</span>  ((<span style=color:#ff79c6>fn </span>[<span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#8be9fd;font-style:italic>y</span>] (<span style=color:#8be9fd;font-style:italic>+ </span><span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#8be9fd;font-style:italic>x</span>)) <span style=color:#bd93f9>10</span> <span style=color:#bd93f9>20</span>)
<span style=color:#6272a4>;; 30</span>
</code></pre></div><p>だったりするが、これはリーダマクロ<code>#()</code>を使うことで</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#8be9fd;font-style:italic>user=&gt;</span> (<span style=color:#ff79c6>#</span>(<span style=color:#8be9fd;font-style:italic>+ </span><span style=color:#8be9fd;font-style:italic>%1</span> <span style=color:#8be9fd;font-style:italic>%2</span>) <span style=color:#bd93f9>10</span> <span style=color:#bd93f9>20</span>)
<span style=color:#6272a4>;; 30</span>
</code></pre></div><p>という感じになる。</p><p>ちなみにこの例での<code>%</code>は引数の順番を表し、<code>%1</code>は第一引数のこと。第一引数は<code>%</code>としてもオッケー。</p><p>こんな感じのマクロ文字がたくさんあるのだけれど、Clojure言語の実装を見てるとだいたいお気持ちが掴めてくるので以下ではそこらへんについてまとめていく。</p><h3 id=clojure言語のソースコードを見る>Clojure言語のソースコードを見る</h3><p>ClojureはJavaで実装されていて、リーダマクロあたりについては以下のあたりのコードに実装されている。</p><p>[https://github.com/clojure/clojure/blob/master/src/jvm/clojure/lang/LispReader.java#L90-L120:embed:cite]</p><p>中身はこうなっている。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	 macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;&#34;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CommentReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;\&#39;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> WrappingReader<span style=color:#ff79c6>(</span>QUOTE<span style=color:#ff79c6>);</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;@&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> WrappingReader<span style=color:#ff79c6>(</span>DEREF<span style=color:#ff79c6>);</span><span style=color:#6272a4>//new DerefReader();
</span><span style=color:#6272a4></span>	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;^&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> MetaReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;`&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> SyntaxQuoteReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;~&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> UnquoteReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;(&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ListReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;)&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> UnmatchedDelimiterReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;[&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> VectorReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;]&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> UnmatchedDelimiterReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;{&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> MapReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;}&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> UnmatchedDelimiterReader<span style=color:#ff79c6>();</span>
<span style=color:#6272a4>//	macros[&#39;|&#39;] = new ArgVectorReader();
</span><span style=color:#6272a4></span>	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;\\&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CharacterReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;%&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArgReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;#&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DispatchReader<span style=color:#ff79c6>();</span>
</code></pre></div><p>これを見てみると<code>#</code>にディスパッチマクロが割り当てられており、ディスパッチマクロについては以下の通りに定義されている。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	 dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;^&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> MetaReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;#&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> SymbolicValueReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;\&#39;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> VarReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;&#34;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RegexReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;(&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> FnReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;{&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> SetReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;=&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> EvalReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;!&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CommentReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;&lt;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> UnreadableReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;_&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DiscardReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;?&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ConditionalReader<span style=color:#ff79c6>();</span>
	dispatchMacros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;:&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> NamespaceMapReader<span style=color:#ff79c6>();</span>
</code></pre></div><p>ディスパッチマクロとは、この場合マクロ文字<code>#</code>以降では別の式に変換するよーというような機能を持ったマクロで、リーダマクロの二段重ねくらいの認識で大丈夫なはず。</p><p>さて、早速中身を見ていこうと思う。</p><h4 id=ダブルクオーテーションとセミコロン>ダブルクオーテーション<code>"</code>とセミコロン<code>;</code></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	 macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;&#34;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> StringReader<span style=color:#ff79c6>();</span>
	macros<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;;&#39;</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CommentReader<span style=color:#ff79c6>();</span>
</code></pre></div><p>これについては変数名の通りで、<code>"</code>は文字列を認識し<code>;</code>はコメントにするものである。</p><p>実際にClojureのコードでは</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#f1fa8c>&#34;Hi Clojure !&#34;</span>)
<span style=color:#6272a4>;; (println &#34;This is a just comment&#34;)</span>
</code></pre></div><p>という感じになっている。</p><h4 id=シングルクオーテーション>シングルクオーテーション<code>\'</code></h4><p>次の<code>\'</code>はシングルクオーテーションで、これはLisperにはお馴染みのシンボルを表す。</p><p>ClojureのシンボルはCommon Lispとは挙動が異なり、Common Lispではシンボルは値を内包していてシンボルと値が同一であるのに対し、Clojureはシンボルと値がそれぞれ独立で、それぞれを名前空間がマッピングしているという構造を持っているらしい。</p><p>変数がunboundになることを想定したときシンボルと値は分けた方が都合がよいのでこのような構造をとっているらしく、ここらへんの挙動についてはRich HickeyのSimple made easyという哲学に基づいているもの、なんだとか。</p><p>少し難しいが、ここらへんも勉強していかないとなぁという感じ。</p><p>ご指摘いただいた<a href=https://twitter.com/lagenorhynque>@lagenorhynque</a>さんありがとうございました！！！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span>)
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#8be9fd;font-style:italic>x</span>) <span style=color:#6272a4>; =&gt; 10</span>
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#f1fa8c>&#39;x</span>) <span style=color:#6272a4>; =&gt; x</span>
(<span style=color:#8be9fd;font-style:italic>println </span>(<span style=color:#ff79c6>quote </span><span style=color:#8be9fd;font-style:italic>x</span>)) <span style=color:#6272a4>; =&gt; x</span>
</code></pre></div><h4 id=アットマーク>アットマーク<code>@</code></h4><p>さて、次の<code>@</code>はCommon Lispの畑からやってきた人間にとってはあまり見慣れないもの。</p><p>Clojureには並行処理をサポートしていて、その際に変数を参照して展開することをこの<code>@</code>は行ってくれる。</p><p>refが参照ならderefが参照はずし(展開するといった方が正確？)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#8be9fd;font-style:italic>x</span> (<span style=color:#8be9fd;font-style:italic>ref </span><span style=color:#bd93f9>10</span>))
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#8be9fd;font-style:italic>x</span>) <span style=color:#6272a4>; =&gt; #object[clojure.lang.Ref 0x17aabeae {:status :ready, :val 10}]</span>
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#ff79c6>@</span><span style=color:#8be9fd;font-style:italic>x</span>) <span style=color:#6272a4>; =&gt; 10</span>
(<span style=color:#8be9fd;font-style:italic>println </span>(<span style=color:#8be9fd;font-style:italic>deref </span><span style=color:#8be9fd;font-style:italic>x</span>)) <span style=color:#6272a4>; =&gt; 10</span>
</code></pre></div><p>ちなみにこの<code>@</code>は遅延評価でも有効らしく、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#8be9fd;font-style:italic>x</span> (<span style=color:#50fa7b>delay</span> <span style=color:#bd93f9>10</span>))
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#8be9fd;font-style:italic>x</span>) <span style=color:#6272a4>; =&gt; #object[clojure.lang.Ref 0x17aabeae {:status :pending, :val 10}]</span>
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#ff79c6>@</span><span style=color:#8be9fd;font-style:italic>x</span>) <span style=color:#6272a4>; =&gt; 10</span>
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#8be9fd;font-style:italic>x</span>) <span style=color:#6272a4>; =&gt; #object[clojure.lang.Ref 0x17aabeae {:status :ready, :val 10}]</span>
</code></pre></div><p>この場合、遅延評価によって実行の前後でステータスがpendingからreadyに変化しているに注意。</p><h4 id=キャレット>キャレット<code>^</code></h4><p>これもまたCommon Lisperには見慣れないもので、Clojureでは実際の変数に対してコンパイル時の型の情報や名前空間などのメタ情報を付加することができる。</p><p>実際、変数をprivateかpublicかのアクセス制限をかけるとき</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#ff79c6>^</span><span style=color:#f1fa8c>:private</span> <span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span>)
(<span style=color:#ff79c6>def </span><span style=color:#ff79c6>^</span>{<span style=color:#f1fa8c>:private</span> <span style=color:#8be9fd;font-style:italic>true</span>} <span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span> <span style=color:#6272a4>;; 上と同じ</span>
</code></pre></div><p>としたり、もしくは型の情報(型ヒント)を明記するとき</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#8be9fd;font-style:italic>defn- </span><span style=color:#8be9fd;font-style:italic>foo</span> [<span style=color:#ff79c6>^</span><span style=color:#8be9fd;font-style:italic>long </span><span style=color:#8be9fd;font-style:italic>i</span> <span style=color:#ff79c6>^</span><span style=color:#8be9fd;font-style:italic>long </span><span style=color:#8be9fd;font-style:italic>j</span>] (<span style=color:#8be9fd;font-style:italic>+ </span><span style=color:#8be9fd;font-style:italic>i</span> <span style=color:#8be9fd;font-style:italic>j</span>))
</code></pre></div><p>とすればオッケー。</p><p>実際にメタ情報を見ようとするなら</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#ff79c6>^</span><span style=color:#f1fa8c>:private</span> <span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span>)
(<span style=color:#8be9fd;font-style:italic>meta </span>(<span style=color:#ff79c6>var </span><span style=color:#8be9fd;font-style:italic>x</span>)) 
<span style=color:#6272a4>;; {:private true, :line 1, :column 1, :file &#34;/private/var/...&#34;</span>
(<span style=color:#8be9fd;font-style:italic>meta </span><span style=color:#ff79c6>#</span><span style=color:#f1fa8c>&#39;x</span>)
</code></pre></div><p>として見れる。</p><p>ここで変数xについて<code>'x</code>がただのシンボルだが<code>#'x</code>はまた特殊で、Clojure では変数や関数の実体への参照として var というものがある。</p><p>よってREPLにて</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span>)
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#8be9fd;font-style:italic>x</span>)
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#f1fa8c>&#39;x</span>)
(<span style=color:#8be9fd;font-style:italic>println </span>(<span style=color:#ff79c6>var </span><span style=color:#8be9fd;font-style:italic>x</span>))
</code></pre></div><p>として見てみると<code>(var x)</code>が名前空間から参照しているのがわかると思う。</p><p>ここらへんは解説するとクソ長くなるのと自分がまだ完全理解してないのでここらへんで切り上げることにする。</p><h4 id=バッククオーテーション--とチルダ>バッククオーテーション<code>`</code>とチルダ<code>~</code></h4><p>バッククオーテーションは式全体をシンボル化し、<code>~</code>はクオートを外す。</p><p>Common Lispだとアンクオートはカンマ<code>,</code>だったけどClojureではチルダ<code>~</code>になっているらしい。</p><p>さて、ここらへんは難しくないのでささっと。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span>)
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#ff79c6>`</span>(<span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>x</span>)) <span style=color:#6272a4>; =&gt; (1 x)</span>
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#ff79c6>`</span>(<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>~</span><span style=color:#8be9fd;font-style:italic>x</span>)) <span style=color:#6272a4>; =&gt; (1 10)</span>
</code></pre></div><p>ちなみにここでクオートされたリストに対してアットマーク<code>@</code>を組み合わせると括弧を外すことができる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#8be9fd;font-style:italic>y</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span>))
(<span style=color:#8be9fd;font-style:italic>println </span><span style=color:#ff79c6>`</span>(<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>~@</span><span style=color:#8be9fd;font-style:italic>y</span>) <span style=color:#6272a4>; =&gt; (1 2 3)</span>
</code></pre></div><p>なんでこんなことができるのかというと、<code>~@</code>がUnquoted Splicingというリーダマクロだから。</p><p>Lispすごい。</p><h4 id=括弧とか----->括弧とか<code>(</code> <code>)</code> <code>{</code> <code>}</code> <code>[</code> <code>]</code></h4><p>ここらへんはリストとか集合とかベクトルとかのデータ型。</p><p>めんどくさいので省略。</p><h4 id=シャープチルダ>シャープ+チルダ<code>#^</code></h4><p>メタデータを付加することができるが、先述のキャレット<code>^</code>単体と何が違うとかというと、<code>#^</code>では独自のkey/valueをメタデータとして付与できる。</p><p>&mldr;というのがClojure1.1とか1.2とかあたりの話らしい。</p><p>なんでも、Clojure1.1ではキャレット<code>^</code>は非推奨で<code>#^</code>を推奨していたらしい。</p><p>しかし手元で試してみたら普通にキャレット<code>^</code>単体でも独自のkey/valueがメタデータとして付与できて、なんだかよくわからない。</p><p>どういう使い分けなんだろう？</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#ff79c6>def </span><span style=color:#ff79c6>#^</span>{<span style=color:#f1fa8c>:fuck-kyoto-univ</span> <span style=color:#bd93f9>114514</span>} <span style=color:#8be9fd;font-style:italic>x</span> <span style=color:#bd93f9>10</span>)
(<span style=color:#8be9fd;font-style:italic>meta </span><span style=color:#ff79c6>#</span><span style=color:#f1fa8c>&#39;x</span>)
</code></pre></div><p>うーん、難しい。</p><blockquote><p>追記. Clojure1.10.1では<code>#^</code>はdeprecatedとなっているらしく、挙動自体は<code>#^</code>と<code>^</code>は変わらないらしい。</p></blockquote><h4 id=シャープシャープ>シャープ+シャープ<code>##</code></h4><p>これはInfなどを表すものらしい。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#8be9fd;font-style:italic>/ </span><span style=color:#bd93f9>1.0</span> <span style=color:#bd93f9>0.0</span>) <span style=color:#6272a4>; =&gt; ##Inf</span>
</code></pre></div><h4 id=シャープシングルクオーテーション>シャープ+シングルクオーテーション<code>#'</code></h4><p>これは<code>(var x)</code>と同じこと。</p><p>さっきやった。</p><h4 id=シャープダブルクオーテーション>シャープ+ダブルクオーテーション<code>#"..."</code></h4><p>はい！出ました！みんな大好き正規表現！！！</p><p>Pythonだと最初に<code>import re</code>とかやって正規表現ライブラリを引っ張ってきて&mldr;みたいな感じでやるけどClojureではデフォルトで正規表現を使えるのでなんと幸せなことだろうか&mldr;.!!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#8be9fd;font-style:italic>re-find </span><span style=color:#ff79c6>#</span><span style=color:#f1fa8c>&#34;\d+&#34;</span> <span style=color:#f1fa8c>&#34;abc12345def&#34;</span>) <span style=color:#6272a4>; =&gt; &#34;12345&#34;</span>
(<span style=color:#8be9fd;font-style:italic>re-matches </span><span style=color:#ff79c6>#</span><span style=color:#f1fa8c>&#34;hello, (.*)&#34;</span> <span style=color:#f1fa8c>&#34;hello, world&#34;</span>) <span style=color:#6272a4>; =&gt; [&#34;hello, world&#34; &#34;world&#34;]</span>
</code></pre></div><p>中の正規表現エンジンが先読みとか再帰とかのイケてるやつまでサポートしてるのかは知らないけど、Javaの正規表現のやつをラップしてる感じらしいので多分サポートしてるはず。</p><h4 id=シャープ括弧>シャープ+括弧<code>#(...)</code></h4><p>これはこのエントリーの最初の例にやったので省略。</p><h4 id=シャープ波括弧>シャープ+波括弧<code>#{...}</code></h4><p>集合ね。省略。</p><h4 id=シャープイコール>シャープ+イコール<code>#=</code></h4><p>これは<code>#=</code>に続くフォームを評価するもので</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#ff79c6>#</span><span style=color:#8be9fd;font-style:italic>=</span>(<span style=color:#8be9fd;font-style:italic>+ </span><span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span>) <span style=color:#6272a4>; =&gt; 6</span>
(<span style=color:#50fa7b>read-string</span> <span style=color:#f1fa8c>&#34;#=(+ 1 2 3)&#34;</span>) <span style=color:#6272a4>; =&gt; 6</span>
</code></pre></div><p>というような感じ。</p><p>一つ注意点として<code>*read-eval*</code>がfalseになっている場合このリードマクロは機能しない。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#8be9fd;font-style:italic>binding </span>[<span style=color:#8be9fd;font-style:italic>*read-eval*</span> <span style=color:#8be9fd;font-style:italic>false</span>] (<span style=color:#50fa7b>read-string</span> <span style=color:#f1fa8c>&#34;#=(+ 1 2 3)&#34;</span>)) 
<span style=color:#6272a4>; =&gt; 計算できませーん</span>
</code></pre></div><h4 id=シャープエクスクラメーションマーク>シャープ+エクスクラメーションマーク<code>#!</code></h4><p>コメントになるらしい。</p><p>シェバンとかで使えそう。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#ff79c6>#</span><span style=color:#8be9fd;font-style:italic>!</span>(<span style=color:#8be9fd;font-style:italic>+ </span><span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span>) <span style=color:#6272a4>; =&gt; 反応なし</span>
</code></pre></div><h4 id=シャープ小なり大なり>シャープ+小なり大なり<code>#&lt;...></code></h4><p>これは以下のformを例外をThrowしてくれるらしい。</p><p>例えば<code>(atom 42)</code>をREPLで評価すると<code>#&lt;Atom: 42></code>とprintされ、これはUnreadableで評価されないものなんだよー的なことが他のサイトに書いてあったけどなんだかよくわからない。</p><p>参照 : <a href=https://cljs.github.io/api/syntax/unreadable>CLJSのUnreadbleのページにて</a></p><h4 id=シャープアンダーバー_>シャープ+アンダーバー<code>#_</code></h4><p>これはコメントの扱いになるらしい。</p><p>つまり読まれず評価されない。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#ff79c6>#</span><span style=color:#8be9fd;font-style:italic>_</span>(<span style=color:#8be9fd;font-style:italic>+ </span><span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>3</span>) <span style=color:#6272a4>; =&gt; 反応なし</span>
</code></pre></div><h4 id=シャープクエスチョンマーク>シャープ+クエスチョンマーク<code>#?</code></h4><p>環境非依存なコードを書くために、環境ごとに条件分岐をしてくれるものらしい。</p><p>どういうことかというと、例えば以下のコードで</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#ff79c6>#</span><span style=color:#8be9fd;font-style:italic>?</span>(<span style=color:#f1fa8c>:clj</span> <span style=color:#f1fa8c>&#34;Hi !&#34;</span> <span style=color:#f1fa8c>:cljs</span> <span style=color:#f1fa8c>&#34;Hello !&#34;</span>)
</code></pre></div><p>実行がClojureなら<code>Hi !</code>とprintされ、ClojureScriptなら<code>Hello !</code>とprintされるらしい。</p><p>そういえばClojureScriptなんてものあったな&mldr;.(Clojureに入門してそこまで時間たってない顔)</p><p>とりあえずこのディスパッチマクロはそういうものらしい。</p><h4 id=シャープコロン>シャープ+コロン<code>#:</code></h4><p>まず、コロン<code>:</code>はキーワード指定子であり、コロン+コロン<code>::</code>は現在の名前空間にキーワードを紐付けるものである。</p><p>その前提で、シャープ+コロン<code>#:</code>は名前空間にキーワードをまとめて紐づけることができる。</p><p>具体的に、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=color:#ff79c6>#</span><span style=color:#f1fa8c>:person</span>{<span style=color:#f1fa8c>:first</span> <span style=color:#f1fa8c>&#34;Han&#34;</span>
         <span style=color:#f1fa8c>:last</span> <span style=color:#f1fa8c>&#34;Solo&#34;</span>
         <span style=color:#f1fa8c>:ship</span> <span style=color:#ff79c6>#</span><span style=color:#f1fa8c>:ship</span>{<span style=color:#f1fa8c>:name</span> <span style=color:#f1fa8c>&#34;Millennium Falcon&#34;</span>
                      <span style=color:#f1fa8c>:model</span> <span style=color:#f1fa8c>&#34;YT-1300f light freighter&#34;</span>}}
</code></pre></div><p>は以下のように読み替えられる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>{<span style=color:#f1fa8c>:person/first</span> <span style=color:#f1fa8c>&#34;Han&#34;</span>
 <span style=color:#f1fa8c>:person/last</span> <span style=color:#f1fa8c>&#34;Solo&#34;</span>
 <span style=color:#f1fa8c>:person/ship</span> {<span style=color:#f1fa8c>:ship/name</span> <span style=color:#f1fa8c>&#34;Millennium Falcon&#34;</span>
               <span style=color:#f1fa8c>:ship/model</span> <span style=color:#f1fa8c>&#34;YT-1300f light freighter&#34;</span>}}
</code></pre></div><p>さて、コロン+コロン<code>::</code>は現在の名前空間にキーワードを紐付けるので<code>#::</code>も同様に</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#8be9fd;font-style:italic>ns </span><span style=color:#8be9fd;font-style:italic>rebel.core</span>
  (<span style=color:#f1fa8c>:require</span>
    [<span style=color:#8be9fd;font-style:italic>rebel.person</span> <span style=color:#f1fa8c>:as</span> <span style=color:#8be9fd;font-style:italic>p</span>]
    [<span style=color:#8be9fd;font-style:italic>rebel.ship</span>   <span style=color:#f1fa8c>:as</span> <span style=color:#8be9fd;font-style:italic>s</span>] ))

<span style=color:#ff79c6>#</span><span style=color:#f1fa8c>::p</span>{<span style=color:#f1fa8c>:first</span> <span style=color:#f1fa8c>&#34;Han&#34;</span>
     <span style=color:#f1fa8c>:last</span> <span style=color:#f1fa8c>&#34;Solo&#34;</span>
     <span style=color:#f1fa8c>:ship</span> <span style=color:#ff79c6>#</span><span style=color:#f1fa8c>::s</span>{<span style=color:#f1fa8c>:name</span> <span style=color:#f1fa8c>&#34;Millennium Falcon&#34;</span>
                <span style=color:#f1fa8c>:model</span> <span style=color:#f1fa8c>&#34;YT-1300f light freighter&#34;</span>}}
</code></pre></div><p>は以下の通りとなる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>{<span style=color:#f1fa8c>:rebel.person/first</span> <span style=color:#f1fa8c>&#34;Han&#34;</span>
 <span style=color:#f1fa8c>:rebel.person/last</span> <span style=color:#f1fa8c>&#34;Solo&#34;</span>
 <span style=color:#f1fa8c>:rebel.person/ship</span> {<span style=color:#f1fa8c>:rebel.ship/name</span> <span style=color:#f1fa8c>&#34;Millennium Falcon&#34;</span>
                     <span style=color:#f1fa8c>:rebel.ship/model</span> <span style=color:#f1fa8c>&#34;YT-1300f light freighter&#34;</span>}}
</code></pre></div><h3 id=まとめ>まとめ</h3><p>意外とリーダマクロはそこまで多くないらしい。</p><p>ただ、いくつか挙動が謎なものもあって、自分でコードを書くときは不安だけどコードを読む分には最低限は大丈夫そう。</p><p>ところでメタデータで型情報を渡したらコンパイルとか速くなるものなんだろうか？</p><p>あくまで型ヒントみたいな感じでPythonのType Hintingみたいにコードに虚無を植え付けるだけとかだと感情も虚無になってしまうので&mldr;.</p><p>とりあえずだんだんとClojureが楽しくなってきた。</p><p>さあこれからもがんばるぞい！</p><hr><ul class=pager><li class=previous><a href=/post/clojure-mini-server/ data-toggle=tooltip data-placement=top title=Clojureで超絶極小サーバーを立てる>&larr;
Previous Post</a></li><li class=next><a href=/post/opengl-from-slime/ data-toggle=tooltip data-placement=top title=SLIMEからOpenGLを触る>Next
Post &rarr;</a></li></ul><div id=disqus-comment></div></div><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href rel=alternate type=application/rss+xml title="Launch Today"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.facebook.com/1230komi/><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/komi1230><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yusuke-kominami-0419b1157/><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Launch Today 2020</p></div></div></div></footer><script>function async(u,c){var d=document,t='script',o=d.createElement(t),s=d.getElementsByTagName(t)[0];o.src=u;if(c){o.addEventListener('load',function(e){c(null,e);},false);}
s.parentNode.insertBefore(o,s);}</script><script>if($('#tag_cloud').length!==0){async("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'},};$('#tag_cloud a').tagcloud();})}</script><script>async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var $nav=document.querySelector("nav");if($nav)FastClick.attach($nav);})</script></body></html>